#!/usr/bin/env bash

# Copyright 2017, Dawid Kurek, <dawikur@gmail.com>

fileJson=$(mktemp)

echo "[ Start ]"

echo "Temporary file: ${fileJson}"

echo "[ Mkdir ]"
  if [ ! -d build ]; then
    mkdir build || exit 1
  fi

echo "[ Building..."; (
  cd build || exit 1
  cmake .. -DCMAKE_BUILD_TYPE=Release -DBENCHMARK=ON || exit 1
  cmake --build . || exit 1
) || exit 1; echo "Builded ]"

echo "[ Running..."
  ./build/test/benchmark/lel_benchmark --benchmark_format=json > "${fileJson}"
echo "Tests done ]"

echo "[ Parsing Json"
  tokens=$(./script/benchmark/parse "${fileJson}")
echo "Json Parsed ]"

echo "[ Generating PNG"
  for token in ${tokens}; do
    files=(${token//__/ })
    type=${files[0]}
    title=${files[1]}

    echo "> ${title}"
    plot_title="${title//_/ }" data_file="${token}" ./script/benchmark/plot/${type} > "res/benchmark/${title}.png"
    rm -v "${token}"
  done
echo "PNG generated ]"

echo "[ Copy json file ]"
cp "${fileJson}" "res/benchmark/dataRaw"

echo "[ Stop ]"

